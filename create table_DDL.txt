CREATE DATABASE FOOD_DELIVERY_APP;

CREATE SCHEMA FOOD_DELIVERY_APP.FOOD_DELIVERY_APP;

CREATE OR REPLACE TABLE DIM_CUSTOMER (
    CUSTOMER_ID VARCHAR(10) PRIMARY KEY,
    CUSTOMER_NAME VARCHAR(100) NOT NULL,
    CITY VARCHAR(50) NOT NULL,
    JOIN_DATE DATE NOT NULL,
    EMAIL VARCHAR(100) UNIQUE,
    PHONE VARCHAR(15) UNIQUE
);

CREATE OR REPLACE TABLE DIM_RESTAURANT (
    RESTAURANT_ID VARCHAR(10) PRIMARY KEY, 
    RESTAURANT_NAME VARCHAR(150) NOT NULL,
    CITY VARCHAR(50) NOT NULL,
    CUISINE_TYPE VARCHAR(50) NOT NULL,
    AVERAGE_RATING NUMBER(3, 2),        
    COMMISSION_RATE NUMBER(4, 3)        
);

CREATE OR REPLACE TABLE DIM_MENU_ITEM (
    MENU_ITEM_ID VARCHAR(10) PRIMARY KEY,
    ITEM_NAME VARCHAR(100) NOT NULL,
    CATEGORY VARCHAR(50),               -- e.g Appetizer
    BASE_PRICE NUMBER(10, 2) NOT NULL
);

CREATE OR REPLACE TABLE DIM_COUPON (
    COUPON_ID VARCHAR(10) PRIMARY KEY,
    COUPON_CODE VARCHAR(20) UNIQUE NOT NULL,
    DISCOUNT_PERCENT NUMBER(5, 2) NOT NULL, 
    MIN_ORDER_VALUE NUMBER(10, 2),
    EXPIRY_DATE DATE
);

CREATE OR REPLACE TABLE FOOD_DELIVERY_APP.FOOD_DELIVERY_APP.FACT_ORDERS (
	ORDER_ID VARCHAR(15) NOT NULL,
	CUSTOMER_ID VARCHAR(10) NOT NULL,
	RESTAURANT_ID VARCHAR(10) NOT NULL,
	COUPON_ID VARCHAR(10),
	ORDER_TIMESTAMP DATE NOT NULL, -- <-- CRITICALLY CHANGED TO DATE
	DELIVERY_FEE NUMBER(10,2) NOT NULL,
	SUB_TOTAL_AMOUNT NUMBER(10,2) NOT NULL,
	DISCOUNT_AMOUNT NUMBER(10,2) DEFAULT 0,
	COMMISSION_REVENUE NUMBER(10,2) NOT NULL,
	PAYMENT_PROCESSING_FEE NUMBER(10,2) NOT NULL,
	TOTAL_AMOUNT NUMBER(10,2) NOT NULL,
	ORDER_RATING NUMBER(3,2),
	primary key (ORDER_ID),
	constraint FK_CUSTOMER_ORDER foreign key (CUSTOMER_ID) references FOOD_DELIVERY_APP.FOOD_DELIVERY_APP.DIM_CUSTOMER(CUSTOMER_ID),
	constraint FK_RESTAURANT_ORDER foreign key (RESTAURANT_ID) references FOOD_DELIVERY_APP.FOOD_DELIVERY_APP.DIM_RESTAURANT(RESTAURANT_ID),
	constraint FK_COUPON_ORDER foreign key (COUPON_ID) references FOOD_DELIVERY_APP.FOOD_DELIVERY_APP.DIM_COUPON(COUPON_ID)
);

CREATE OR REPLACE TABLE FACT_ORDER_ITEMS (
    ORDER_ITEM_ID VARCHAR(20) PRIMARY KEY,
    ORDER_ID VARCHAR(15) NOT NULL,
    MENU_ITEM_ID VARCHAR(10) NOT NULL,
    QUANTITY NUMBER(5, 0) NOT NULL,
    ITEM_PRICE_AT_ORDER NUMBER(10, 2) NOT NULL, -- Price to calculate subtotal
    CONSTRAINT FK_ORDER_DETAIL FOREIGN KEY (ORDER_ID) REFERENCES FACT_ORDERS(ORDER_ID),
    CONSTRAINT FK_MENU_DETAIL FOREIGN KEY (MENU_ITEM_ID) REFERENCES DIM_MENU_ITEM(MENU_ITEM_ID)
);

CREATE OR REPLACE VIEW V_PLATFORM_PROFITABILITY AS (
    SELECT
        -- Keys and Dimension Attributes
        O.ORDER_ID,
        O.ORDER_TIMESTAMP,  -- Now the simple DATE type
        O.CUSTOMER_ID,
        C.CUSTOMER_NAME,
        O.RESTAURANT_ID,
        R.RESTAURANT_NAME,
        R.CITY,
        R.CUISINE_TYPE,
        
        -- Financials (Metrics)
        O.TOTAL_AMOUNT AS GMV, -- Gross Merchandise Value (Total amount paid by customer)
        
        -- Revenue Components (Platform Earnings)
        O.DELIVERY_FEE,
        O.COMMISSION_REVENUE,
        
        -- Cost Components (Platform Expenses)
        O.DISCOUNT_AMOUNT,
        O.PAYMENT_PROCESSING_FEE,

        -- NET PROFIT CALCULATION (CORE METRIC)
        (O.DELIVERY_FEE + O.COMMISSION_REVENUE) - 
        (O.DISCOUNT_AMOUNT + O.PAYMENT_PROCESSING_FEE) AS NET_PROFIT,
        
        O.ORDER_RATING

    FROM FACT_ORDERS O
    JOIN DIM_CUSTOMER C ON O.CUSTOMER_ID = C.CUSTOMER_ID
    JOIN DIM_RESTAURANT R ON O.RESTAURANT_ID = R.RESTAURANT_ID
);

CREATE OR REPLACE VIEW V_PLATFORM_FILTERED AS
SELECT
    O.ORDER_ID,
    O.ORDER_TIMESTAMP,
    C.CUSTOMER_ID,
    C.CUSTOMER_NAME,
    C.CITY AS CUSTOMER_CITY,
    R.RESTAURANT_ID,
    R.RESTAURANT_NAME,
    R.CITY AS RESTAURANT_CITY,
    R.CUISINE_TYPE,
    O.TOTAL_AMOUNT AS GMV,
    O.DELIVERY_FEE,
    O.COMMISSION_REVENUE,
    O.DISCOUNT_AMOUNT,
    O.PAYMENT_PROCESSING_FEE,
    (O.DELIVERY_FEE + O.COMMISSION_REVENUE) - 
    (O.DISCOUNT_AMOUNT + O.PAYMENT_PROCESSING_FEE) AS NET_PROFIT,
    O.ORDER_RATING
FROM FACT_ORDERS O
JOIN DIM_CUSTOMER C ON O.CUSTOMER_ID = C.CUSTOMER_ID
JOIN DIM_RESTAURANT R ON O.RESTAURANT_ID = R.RESTAURANT_ID;

CREATE OR REPLACE VIEW V_FILTER_CITY AS
SELECT
    R.CITY AS CITY,
    COUNT(O.ORDER_ID) AS TOTAL_ORDERS,
    SUM(O.TOTAL_AMOUNT) AS TOTAL_GMV,
    SUM((O.DELIVERY_FEE + O.COMMISSION_REVENUE) - 
        (O.DISCOUNT_AMOUNT + O.PAYMENT_PROCESSING_FEE)) AS TOTAL_NET_PROFIT
FROM FACT_ORDERS O
JOIN DIM_RESTAURANT R ON O.RESTAURANT_ID = R.RESTAURANT_ID
GROUP BY R.CITY
ORDER BY TOTAL_GMV DESC;

CREATE OR REPLACE VIEW V_FILTER_RESTAURANT AS
SELECT
    R.RESTAURANT_ID,
    R.RESTAURANT_NAME,
    R.CITY,
    R.CUISINE_TYPE,
    COUNT(O.ORDER_ID) AS TOTAL_ORDERS,
    SUM(O.TOTAL_AMOUNT) AS TOTAL_GMV,
    SUM((O.DELIVERY_FEE + O.COMMISSION_REVENUE) - 
        (O.DISCOUNT_AMOUNT + O.PAYMENT_PROCESSING_FEE)) AS TOTAL_NET_PROFIT,
    ROUND(AVG(O.ORDER_RATING), 2) AS AVG_RATING
FROM FACT_ORDERS O
JOIN DIM_RESTAURANT R ON O.RESTAURANT_ID = R.RESTAURANT_ID
GROUP BY R.RESTAURANT_ID, R.RESTAURANT_NAME, R.CITY, R.CUISINE_TYPE
ORDER BY TOTAL_GMV DESC;

CREATE OR REPLACE VIEW V_FILTER_CATEGORY AS
SELECT
    R.CUISINE_TYPE AS CATEGORY,
    COUNT(O.ORDER_ID) AS TOTAL_ORDERS,
    SUM(O.TOTAL_AMOUNT) AS TOTAL_GMV,
    SUM((O.DELIVERY_FEE + O.COMMISSION_REVENUE) - 
        (O.DISCOUNT_AMOUNT + O.PAYMENT_PROCESSING_FEE)) AS TOTAL_NET_PROFIT,
    ROUND(AVG(O.ORDER_RATING), 2) AS AVG_RATING
FROM FACT_ORDERS O
JOIN DIM_RESTAURANT R ON O.RESTAURANT_ID = R.RESTAURANT_ID
GROUP BY R.CUISINE_TYPE
ORDER BY TOTAL_GMV DESC;


